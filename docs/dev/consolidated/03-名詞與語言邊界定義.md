# 名詞與語言邊界定義

## Ubiquitous Language（統一語言）

本專案採用 Domain-Driven Design (DDD) 的統一語言原則，確保技術實作與業務概念一致。

### 核心領域術語

#### Event Sourcing 層

**Event（事件）**
- 定義：已發生的業務事實，不可變更
- 特性：Immutable、Traceable、Permanent
- 範例：TaskCreated, TaskCompleted, OrderPlaced

**Event Store（事件存儲）**
- 定義：所有事件的唯一真相來源
- 職責：追加事件、查詢事件流、維護因果鏈
- 實作：Firebase/Supabase/IndexedDB

**Causality（因果關係）**
- 定義：事件之間的前驅後繼關係
- 表達：causedBy 欄位記錄前驅事件 ID
- 價值：完整追溯、責任歸屬、流程分析

**Projection（投影）**
- 定義：從事件流重建的狀態視圖
- 特性：Pure Function、可重複計算、多視圖
- 範例：TaskListView, TaskBoardView, TaskWhyView

#### Task 領域

**Task（任務）**
- 定義：需要人類決策或操作的待辦項目
- 本質：Event Stream 的派生視圖
- 狀態：Pending, Assigned, InProgress, Blocked, Completed

**Process（流程）**
- 定義：標準化的業務流程定義
- 職責：定義標準步驟、建議下一步行動
- 特性：可重複、可變體、可優化

**Work Package（工作包）**
- 定義：實際執行的工作包
- 層次：Contract → Work Package → Task
- 特性：規劃階段可調整

#### Platform 層

> **重要原則**（from ✨✨✨.md, ✨✨✨✨✨.md）:  
> Platform 提供 **WHO (Account)** 和 **WHERE (Workspace)**，不是業務實體。

**Account（帳號）**
- 定義：唯一的業務行為主體（Business Actor）
- 類型：UserAccount, OrganizationAccount, BotAccount
- 職責：觸發事件（actorAccountId）、被授權、被指派
- 特性：會出現在事件中，是因果鏈的主體
- 參考：[Account Model](../../04-core-model/05-account-model.md)

**Workspace（工作空間）**
- 定義：業務模組的邏輯容器
- 職責：定義範圍邊界、資料隔離、權限 Scope
- 特性：**不觸發事件**，只作為 workspaceId 出現
- 關係：Account ↔ Workspace via AccountWorkspaceMembership
- 參考：[Workspace Model](../../04-core-model/06-workspace-model.md)

**User Identity（用戶身份）**
- 定義：Account 的身份來源（非業務實體）
- 特性：有登入行為、Email/OAuth、驗證機制
- 關係：產生 UserAccount

**Organization Identity（組織身份）**
- 定義：Account 的身份來源（非業務實體）
- 特性：不能登入、由 User Account 管理、法律主體
- 關係：產生 OrganizationAccount

**Bot Identity（機器人身份）**
- 定義：Account 的身份來源（非業務實體）
- 特性：API Token 驗證、受限權限、可撤銷
- 關係：產生 BotAccount

**AccountWorkspaceMembership（帳號工作空間成員關係）**
- 定義：Account 與 Workspace 之間的權限關係
- 屬性：accountId, workspaceId, role (owner/admin/member/viewer)
- 原則：權限是關係，不是屬性

⚠️ **重要區別**：
- **Account**: 是 Actor（誰做的），會觸發事件
- **Workspace**: 是 Scope（在哪），定義範圍
- **User/Org/Bot Identity**: 是身份來源，不直接參與業務

❌ **已廢棄術語**：
- ~~User（用戶）作為業務主體~~ → 使用 **UserAccount** 或 **User Identity**
- ~~Organization（組織）作為業務主體~~ → 使用 **OrganizationAccount** 或 **Organization Identity**
- ~~Team（團隊）~~ → 功能待重新定義或移除
- ~~Collaborator（協作者）~~ → 用 AccountWorkspaceMembership 取代


### 架構層次術語

#### Core 層

**Policy（策略）**
- 定義：集中化的授權決策引擎
- 職責：判斷權限、驗證規則
- 原則：Feature 不自行判斷權限

**Contract（契約）**
- 定義：跨邊界的接口定義
- 範圍：DTO、Event Schema、API
- 原則：Feature 間只能透過 Contract 溝通

**Result（結果）**
- 定義：錯誤處理的統一模式
- 類型：Result.Ok / Result.Err
- 原則：禁止 throw Error、禁止 null

**Audit（審計）**
- 定義：系統行為的完整記錄
- 來源：Domain Events
- 價值：合規、追溯、分析

#### Feature 層

**Domain（領域）**
- 定義：業務邏輯的核心
- 限制：不知道 UI、不知道 Infrastructure
- 原則：Pure Function、無副作用

**Application（應用）**
- 定義：業務流程的編排層
- 職責：調用 Policy、組合 Domain、呼叫 Repository
- 原則：薄層、無業務邏輯

**Saga / Process Manager**
- 定義：跨 Aggregate 的長流程協調
- 職責：監聽事件、觸發補償、維護狀態
- 原則：不擁有資料、不寫業務規則

**Capability（能力）**
- 定義：平台提供的可選功能
- 特性：被動、可插拔、不影響 Domain
- 範例：通知、搜尋、匯出

#### Infrastructure 層

**Repository（倉儲）**
- 定義：Aggregate 的持久化接口
- 實作：Firebase、Supabase、IndexedDB
- 原則：實作 Core 定義的接口

**Event Bus（事件匯流排）**
- 定義：事件發布訂閱機制
- 職責：publish、subscribe、路由
- 實作：RxJS Subject / Firebase Realtime

**Adapter（適配器）**
- 定義：外部系統的抽象層
- 職責：轉換協議、處理錯誤、重試
- 原則：不洩漏外部概念到 Domain

### CQRS 術語

**Command（命令）**
- 定義：表達意圖的操作請求
- 範例：CreateTask, CompleteTask, AssignTask
- 結果：產生 Event 或 Error

**Query（查詢）**
- 定義：無副作用的資料查詢
- 來源：Read Model
- 原則：不改變狀態、不產生事件

**Read Model（讀模型）**
- 定義：優化查詢的預先計算視圖
- 更新：由 Event Handler 維護
- 特性：可重建、可多種格式

**Write Model（寫模型）**
- 定義：Event Store 本身
- 操作：只能 Append
- 原則：Immutable、Complete

## 語言邊界（Bounded Context）

### Task Domain（任務領域）

**邊界內**：
- Task、Event、Projection、Decision、Process
- 任務生命週期、狀態轉換、協作機制

**邊界外**：
- Platform 實體（只能引用，不能修改）
- Infrastructure 細節（只能透過接口）

**交互方式**：
- 發布 Domain Event
- 接收 Platform 引用（userId, orgId）

### Platform Domain（平台領域）

**邊界內**：
- Account、Workspace、AccountWorkspaceMembership
- User/Organization/Bot Identity（身份來源）
- 認證機制、多租戶隔離、權限範圍定義

**邊界外**：
- Task 業務邏輯（不關心任務細節）
- Infrastructure 實作（只定義接口）

**交互方式**：
- 提供 AuthContext（包含 accountId, workspaceId）
- Platform 不做授權決策，只提供身份驗證
- Domain 使用 Account 和 Workspace 進行業務授權

**核心原則**：
- Account 是 WHO（誰做的）
- Workspace 是 WHERE（在哪做）
- Platform 提供這兩個概念，但不包含業務邏輯

### Bounded Context 溝通規則

1. **Anti-Corruption Layer（防腐層）**
   - 外部概念不直接進入 Domain
   - 透過 Adapter 轉換為 Domain 語言

2. **Event-Driven Integration**
   - 跨 Context 透過 Event 溝通
   - 不直接呼叫對方的 Domain

3. **Shared Kernel（共享核心）**
   - Core 層的 Contract、Policy、Result
   - 全域共享，但版本嚴格管理

## 禁用術語（避免歧義）

❌ **狀態**（State）
- 問題：容易與資料庫狀態混淆
- 替代：View、Projection、Snapshot

❌ **儲存**（Save）
- 問題：暗示修改現有資料
- 替代：Append Event、Commit

❌ **刪除**（Delete）
- 問題：違反 Event Sourcing 不可變原則
- 替代：Mark as Cancelled、Soft Delete Event

❌ **更新**（Update）
- 問題：暗示修改現有記錄
- 替代：Apply Event、Transition State

❌ **同步**（Sync）
- 問題：與 async 混淆
- 替代：Replay、Reconcile、Converge

## 術語使用規範

### 程式碼命名

```typescript
// ✅ 正確 - Event Sourcing
TaskCreatedEvent
CreateTaskCommand
TaskListProjection
CompleteTaskDecision

// ✅ 正確 - Account/Workspace
actorAccountId              // 事件中的 Actor
workspaceId                 // 事件中的 Scope
AccountCreatedEvent
WorkspaceCreatedEvent
AccountWorkspaceMembership

// ❌ 錯誤
TaskCreateEvent             // 應該是過去式 TaskCreated
CreateTaskEvent             // Command 不是 Event
TaskListState               // 應該是 Projection
CompleteTaskValidator       // 應該是 Decision
userId                      // 應該是 actorAccountId
orgId                       // 應該是 actorAccountId (Organization 也是 Account)
createdBy                   // 應該是 createdByAccountId
assignedTo                  // 應該是 assigneeAccountId
```

### 文件撰寫

```markdown
✅ 正確：
- 「當 TaskCompleted 事件發生時」
- 「Projection 從事件流重建視圖」
- 「Domain 層不知道 Infrastructure」
- 「Account 觸發事件，Workspace 定義範圍」
- 「User Identity 產生 UserAccount」
- 「actorAccountId 指向觸發事件的 Account」

❌ 錯誤：
- 「當任務完成時更新資料庫」
- 「從資料庫讀取任務狀態」
- 「Service 呼叫 DAO」
- 「User 觸發事件」（應該是 Account）
- 「Organization 是多租戶邊界」（應該是 Workspace）
- 「userId 作為事件主體」（應該是 accountId）
```

### 討論溝通

**業務討論**：
- 使用 Domain 術語（Task, Event, Process）
- 避免技術術語（Table, Column, API）

**技術討論**：
- 明確區分層次（Domain vs Infrastructure）
- 使用統一的架構術語（Projection, Saga）

## 術語演進

### 版本管理

當術語需要調整時：
1. 在此文件記錄變更
2. 更新所有相關文件
3. 標記舊術語為 Deprecated
4. 提供遷移期（至少一個 Sprint）

### 新增術語流程

1. 確認沒有現有術語可用
2. 定義清晰的範圍和職責
3. 在此文件新增條目
4. 團隊 Review 通過
5. 開始使用

---

**版本**: 2.0  
**更新日期**: 2026-01-01  
**維護者**: Architecture Team  
**重大變更**: 引入 Account/Workspace 模型，取代 User/Organization 作為業務主體
