---

# ğŸ” ä¸€ã€Firestore Security Rulesï¼ˆå°æ‡‰ Membershipï¼‰

## ğŸ¯ è¨­è¨ˆæ ¸å¿ƒå¿ƒæ³•ï¼ˆè¶…é‡è¦ï¼‰

è«‹å…ˆè¨˜ä½é€™ä¸€å¥ï¼ˆçœŸçš„è¦è¨˜ï¼‰ï¼š

> **Firestore Rules ä¸åšå•†æ¥­é‚è¼¯
> åªåšã€Œä½ æ˜¯ä¸æ˜¯é€™å€‹ Workspace çš„äººã€**

* âŒ ä¸åˆ¤æ–· Saga
* âŒ ä¸åˆ¤æ–· Module å•Ÿç”¨æµç¨‹
* âœ… åªæ ¹æ“š **Membership Projection**

---

## ğŸ”‘ åŸºæœ¬å‰æ

å‡è¨­ï¼š

* ä½¿ç”¨ Firebase Auth
* `request.auth.uid` = userId
* Membership å­˜åœ¨æ–¼
  `/memberships/{workspaceId}_{userId}`

---

## ğŸ§± Rules æª”æ¡ˆçµæ§‹ï¼ˆæ¦‚å¿µï¼‰

```txt
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // helpers
    function isSignedIn() {
      return request.auth != null;
    }

    function membership(workspaceId) {
      return get(
        /databases/$(database)/documents/memberships/$(workspaceId + "_" + request.auth.uid)
      );
    }

    function hasMembership(workspaceId) {
      return membership(workspaceId).exists();
    }

    function role(workspaceId) {
      return membership(workspaceId).data.role;
    }
```

---

## ğŸ§© Workspace Rules

```rules
match /workspaces/{workspaceId} {
  allow read: if isSignedIn() && hasMembership(workspaceId);

  // âŒ å‰ç«¯æ°¸é ä¸èƒ½å¯« Workspace
  allow write: if false;
}
```

ğŸ‘‰ Workspace æ˜¯ **Saga / Admin** çš„äº‹
ğŸ‘‰ å‰ç«¯åªè®€ï¼Œéå¸¸ä¹¾æ·¨

---

## ğŸ‘¤ Membership Rulesï¼ˆåªè®€è‡ªå·±ï¼‰

```rules
match /memberships/{id} {
  allow read: if isSignedIn()
    && id == request.resource.id;

  // âŒ ä¸å…è¨±å‰ç«¯æ”¹è§’è‰²
  allow write: if false;
}
```

ğŸ‘‰ æˆå“¡è®Šå‹• = Domain Command
ğŸ‘‰ ä¸çµ¦å‰ç«¯ç¢°ï¼Œé¿å…ç½é›£ ğŸ˜Œ

---

## ğŸ§© Module Projection Rules

```rules
match /modules/{id} {
  allow read: if isSignedIn()
    && hasMembership(resource.data.workspaceId);

  allow write: if false;
}
```

ğŸ‘‰ å‰ç«¯åªèƒ½ã€Œçœ‹ä¸–ç•Œé•·æ€æ¨£ã€
ğŸ‘‰ ä¸èƒ½æ”¹ä¸–ç•Œè¦å‰‡

---

## ğŸ§  Saga Instance Rulesï¼ˆå¯è®€é€²åº¦ï¼‰

```rules
match /saga-instances/{sagaId} {
  allow read: if isSignedIn()
    && hasMembership(resource.data.workspaceId);

  allow write: if false;
}
```

ğŸ‘‰ UI å¯ä»¥é¡¯ç¤ºã€Œåˆå§‹åŒ–ä¸­ / å¤±æ•—ã€
ğŸ‘‰ ä½†ä¸èƒ½æ“æ§ Saga

---

## ğŸ§¾ Task Projection Rulesï¼ˆSaaS Domainï¼‰

```rules
match /tasks/{taskId} {
  allow read: if isSignedIn()
    && hasMembership(resource.data.workspaceId);

  allow create: if isSignedIn()
    && hasMembership(request.resource.data.workspaceId)
    && role(request.resource.data.workspaceId) in ['Owner', 'Admin', 'Member'];

  allow update, delete: if false;
}
```

ğŸ”¥ é‡é»ï¼š

* å»ºç«‹ Taskï¼šå‰ç«¯å¯ä»¥ï¼ˆå— Membership æ§åˆ¶ï¼‰
* æ›´æ–° / åˆªé™¤ï¼š**äº¤çµ¦ Command / Function**

---

## ğŸ§· å°çµï¼ˆSecurity Rulesï¼‰

> **Rules æ˜¯ç‰†ï¼Œä¸æ˜¯è…¦è¢‹**
> è…¦è¢‹åœ¨ Domain / Saga
> ç‰†åªç®¡ã€Œä½ èƒ½ä¸èƒ½é€²ä¾†ã€

ä½ é€™æ¨£å¯«ï¼Œç³»çµ±æœƒï¼š

* ä¸è¢«å‰ç«¯ç©å£
* ä¸è¢«è§’è‰²ç¹é
* å¥½ Debug

---

# ğŸ”„ äºŒã€Projection é‡å»ºç­–ç•¥ï¼ˆReplay Eventsï¼‰

é€™ä¸€æ®µæ˜¯ **Event-Sourced ç³»çµ±çš„ã€Œå¾©æ´»è¡“ã€** ğŸ§™â€â™‚ï¸
æˆ‘æœƒè¬›ä¸‰å±¤ï¼Œä¸æœƒç©ºè«‡ã€‚

---

## ğŸ¯ ç‚ºä»€éº¼ä¸€å®šè¦èƒ½ Replayï¼Ÿ

å› ç‚ºä½ ä¸€å®šæœƒé‡åˆ°ï¼š

* Projection schema æ”¹äº†
* UI æ–°éœ€æ±‚
* Bug ä¿®æ‰å¾Œè¦é‡ç®—
* æ–° Module è¦è£œèˆŠè³‡æ–™

ğŸ‘‰ **ä¸èƒ½ Replay = ä¸æ•¢æ”¹ç³»çµ±**

---

## ğŸ§  äº‹ä»¶å„²å­˜å‰æï¼ˆä½ å·²ç¶“æœ‰ï¼‰

```txt
event-store/
â””â”€â”€ events/
    â”œâ”€â”€ AccountCreated
    â”œâ”€â”€ WorkspaceCreated
    â”œâ”€â”€ MemberJoinedWorkspace
    â”œâ”€â”€ ModuleEnabled
    â”œâ”€â”€ TaskCreated
```

æ¯å€‹ Event éƒ½æœ‰ï¼š

```ts
{
  eventId,
  type,
  payload,
  occurredAt,
  causationId,
  correlationId
}
```

---

## ğŸ” Projection Builderï¼ˆæ ¸å¿ƒæ¦‚å¿µï¼‰

> **Projection = fold(events[])**

```ts
function buildWorkspaceProjection(events: DomainEvent[]) {
  let state = initialWorkspaceState;

  for (const event of events) {
    state = apply(event, state);
  }

  return state;
}
```

ğŸ‘‰ é€™æ˜¯**ç´”å‡½æ•¸**
ğŸ‘‰ ä¸ç¢° Firestore
ğŸ‘‰ ä¸ç¢° SDK

---

## ğŸ§± Replay ç­–ç•¥ï¼ˆä¸‰ç¨®å±¤ç´šï¼‰

---

### 1ï¸âƒ£ å…¨é‡é‡å»ºï¼ˆç½å¾Œé‡ç”Ÿï¼‰

```txt
1. æ¸…ç©º Firestore projection collections
2. å¾ Event Store è®€å–å…¨éƒ¨äº‹ä»¶
3. ä¾åº apply
4. å¯«å› Projection
```

âœ” é©åˆï¼š

* Schema å¤§æ”¹
* ä¸Šç·šå‰
* ç·Šæ€¥ä¿®å¾©

---

### 2ï¸âƒ£ å–® Aggregate é‡å»ºï¼ˆæœ€å¸¸ç”¨ï¼‰

```txt
ReplayWorkspace(workspaceId)
```

æµç¨‹ï¼š

```txt
Fetch events where payload.workspaceId == wsId
â†’ rebuild
â†’ overwrite:
  /workspaces/{wsId}
  /modules/{wsId}_*
  /memberships/{wsId}_*
```

ğŸ”¥ **é€™å€‹ä½ ä¹‹å¾Œä¸€å®šæœƒå¸¸ç”¨**

---

### 3ï¸âƒ£ å¢é‡é‡æ”¾ï¼ˆæ­£å¸¸é‹ä½œï¼‰

```txt
lastProcessedEventId
â†’ åªè™•ç†æ–°çš„äº‹ä»¶
```

Projection æ–‡ä»¶åŠ ä¸€å€‹æ¬„ä½ï¼š

```json
{
  "_meta": {
    "lastEventId": "evt_999"
  }
}
```

ğŸ‘‰ Saga / Projection Handler æ¯æ¬¡åªåƒæ–°äº‹ä»¶
ğŸ‘‰ å¿«åˆç©©

---

## ğŸ§ª Replay çš„å®‰å…¨æŠ€å·§ï¼ˆå¾ˆé‡è¦ï¼‰

### âœ” Projection æ°¸é å¯è¢«åˆª

* ä¸å­˜ã€Œå”¯ä¸€çœŸç›¸ã€
* çœŸç›¸åªåœ¨ Event Store

### âœ” Projection å¯«å…¥è¦ idempotent

```ts
if (eventId <= lastEventId) return;
```

---

## ğŸ§· æœ€å¾Œä¸€å¥ï¼ˆè«‹ä½ çœŸçš„è¨˜ä½ï¼‰

> **Security Rules ä¿è­·ç¾åœ¨
> Replay èƒ½ä¿®å¾©éå»
> Event Store æ‰æ˜¯æ°¸æ†**

ä½ ç¾åœ¨é€™å¥—ç³»çµ±å·²ç¶“æ˜¯ï¼š

* çœŸæ­£å®‰å…¨
* çœŸæ­£å¯é‡å»º
* çœŸæ­£æ•¢æ”¹
