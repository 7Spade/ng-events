---

ğŸ§¬ 1ï¸âƒ£ Eventï¼ˆäº‹ä»¶çµæ§‹ï¼‰â€”ã€Œç™¼ç”Ÿäº†ã€

æ³›å‹å®šç¾©ï¼ˆKernel ç´šï¼‰

export interface Event<
  TType extends string = string,
  TPayload = unknown
> {
  readonly eventId: string
  readonly type: TType
  readonly payload: TPayload
  readonly occurredAt: Date

  readonly causation?: Causation
  readonly correlationId?: string
}

æ ¸å¿ƒä¸è®Šé‡

eventIdï¼šå”¯ä¸€

typeï¼šèªæ„é‚Šç•Œï¼ˆä¸å¯æ³›åŒ–æˆ enumï¼‰

payloadï¼šåªæ”¾äº‹å¯¦ï¼Œä¸æ”¾æ±ºç­–

ä¸å¯è®Šã€å¯é‡æ’­



---

ğŸ”— 2ï¸âƒ£ Causation / Correlation â€”ã€Œç‚ºä»€éº¼æœƒç™¼ç”Ÿã€

Causationï¼ˆçˆ¶å­é—œä¿‚ï¼‰

export interface Causation {
  readonly eventId: string
  readonly type: string
}

Correlationï¼ˆæ•…äº‹ç·šï¼‰

export type CorrelationId = string

ä¸è®Šè¦å‰‡

æ¯å€‹éèµ·é»äº‹ä»¶ï¼Œéƒ½æ‡‰è©²æœ‰ causation

Saga / æµç¨‹å¿…é ˆå…±ç”¨ correlationId

correlation â‰  causationï¼ˆå¾ˆå¤šäººæœƒææ··ï¼‰



---

ğŸ§  3ï¸âƒ£ Saga State Machine â€”ã€Œäº‹æƒ…æ€éº¼ç¹¼çºŒã€

Saga Contextï¼ˆç‹€æ…‹è¼‰é«”ï¼‰

export interface SagaContext {
  readonly sagaId: string
  readonly status: 'pending' | 'completed' | 'failed'
}

Sagaï¼ˆç´”åæ‡‰å™¨ï¼‰

export interface Saga<
  TContext extends SagaContext,
  TEvent extends Event
> {
  readonly sagaType: string

  initialContext(event: TEvent): TContext

  transition(
    context: TContext,
    event: TEvent
  ): SagaTransition<TContext> | null
}

æ ¸å¿ƒæ¦‚å¿µ

Saga ä¸æ˜¯ service

Saga ä¸ç›´æ¥åšäº‹

åªåšä¸€ä»¶äº‹ï¼š
ã€Œçœ‹åˆ°äº‹ä»¶ â†’ æ±ºå®šç‹€æ…‹æ€éº¼è®Šã€



---

ğŸ”€ 4ï¸âƒ£ Saga Step / Transition â€”ã€Œæ¥ä¸‹ä¾†ã€

Transitionï¼ˆç‹€æ…‹é·ç§»ï¼‰

export interface SagaTransition<TContext> {
  readonly nextContext: TContext
  readonly commands?: Command[]
}

ç‚ºä»€éº¼è¦åˆ†é–‹ï¼Ÿ

å› ç‚ºï¼š

ç‹€æ…‹æ”¹è®Šæ˜¯äº‹å¯¦

Command æ˜¯æ„åœ–ï¼ˆå¯èƒ½å¤±æ•—ï¼‰


ğŸ‘‰ é€™æ˜¯å¯é‡æ’­çš„é—œéµ


---

ğŸ§¯ 5ï¸âƒ£ Compensationï¼ˆè£œå„Ÿï¼‰â€”ã€Œå¦‚æœå£äº†ã€

è£œå„Ÿå®šç¾©

export interface Compensation<TContext extends SagaContext> {
  when(context: TContext): boolean

  execute(context: TContext): Command[]
}

ä¸è®ŠåŸå‰‡

è£œå„Ÿæ˜¯ äº‹å¾Œåæ‡‰

è£œå„Ÿåªä¾è³´ Saga Context

ä¸æ˜¯ rollback DB

æ˜¯ã€Œç™¼é€åå‘æ„åœ–ã€



---

ğŸ§© 6ï¸âƒ£ Commandï¼ˆè£œé½Šä½ ä¸€å®šéœ€è¦çš„é‚£å¡Šï¼‰

export interface Command<
  TType extends string = string,
  TPayload = unknown
> {
  readonly type: TType
  readonly payload: TPayload
  readonly correlationId?: string
  readonly causation?: Causation
}

> Event = å·²ç™¼ç”Ÿ
Command = æƒ³ç™¼ç”Ÿ



é€™æ¢ç•Œç·šå®ˆä½ï¼Œä½ ç³»çµ±å°±ä¸æœƒç˜‹ã€‚


---

ğŸ§  7ï¸âƒ£ å…¨éƒ¨æ‹¼èµ·ä¾†ï¼ˆå¿ƒæ™ºæ¨¡å‹ï¼‰

Event
  â†“
Saga.transition(context, event)
  â†“
SagaTransition
  â”œâ”€ nextContext
  â””â”€ Commands
        â†“
   ï¼ˆä¸–ç•ŒåŸ·è¡Œï¼‰
        â†“
   æ–° Event

é€™æ˜¯ä¸€å€‹ é–‰ç’°ã€å¯ replayã€å¯ debug çš„ç³»çµ±ã€‚


---

ğŸª„ æœ€é‡è¦çš„ä¸€å¥ï¼ˆè«‹ä½ è¨˜ä½ï¼‰

> æ³›å‹æ˜¯ç‚ºäº†ã€Œä¿è­·èªæ„ã€ï¼Œä¸æ˜¯ç‚ºäº†ã€ŒæŠ½æ‰èªæ„ã€



ä½ é€™å¥—æŠ½è±¡ï¼š

ä¸çŸ¥é“ Account

ä¸çŸ¥é“ Workspace

ä¸çŸ¥é“ Firebase


ä½†å®ƒçŸ¥é“ï¼š

å› æœ

æµç¨‹

å¤±æ•—

è£œå„Ÿ



---

