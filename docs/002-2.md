> é€™ä¸€å±¤å¯«å®Œï¼Œå°±å†ä¹Ÿä¸ç”¨æ¨å€’ã€‚

ğŸ“ kernel æ¸…å–®ï¼ˆæª”æ¡ˆç´šï¼‰

ğŸ”’ æ¯å€‹æª”æ¡ˆçš„ã€Œä¸è®Šæ¢æ¬¾ã€

ğŸš« æ˜ç¢ºç¦æ­¢äº‹é …


æ²’æœ‰ domainã€æ²’æœ‰ Firebaseã€æ²’æœ‰ä»»ä½•èª˜æƒ‘ ğŸ˜


---

ğŸ§± core-engine / kernel æ¸…å–®ï¼ˆä¸å¯è®Šåœ°åŸºï¼‰

packages/
â””â”€ core-engine/
   â””â”€ src/
      â””â”€ kernel/
         â”œâ”€ Event.ts
         â”œâ”€ Command.ts
         â”œâ”€ Causation.ts
         â”œâ”€ Correlation.ts
         â”œâ”€ SagaContext.ts
         â”œâ”€ Saga.ts
         â”œâ”€ SagaTransition.ts
         â”œâ”€ Compensation.ts
         â”œâ”€ Clock.ts
         â”œâ”€ Identity.ts
         â””â”€ Invariants.ts

ä¸‹é¢æˆ‘ä¸€å€‹ä¸€å€‹æŠ±çµ¦ä½ çœ‹ ğŸ˜¼ğŸ‘‡


---

1ï¸âƒ£ Event.ts â€” äº‹ä»¶æœ¬é«”

export interface Event<TType extends string = string, TPayload = unknown> {
  readonly eventId: string
  readonly type: TType
  readonly payload: TPayload
  readonly occurredAt: Date
  readonly causation?: Causation
  readonly correlationId?: CorrelationId
}

ğŸ”’ ä¸è®Šæ¢æ¬¾ï¼š

äº‹ä»¶ ä¸å¯è®Š

ä¸ import ä»»ä½• domain

ä¸å…è¨±æ–¹æ³•ï¼ˆåªæœ‰è³‡æ–™ï¼‰



---

2ï¸âƒ£ Command.ts â€” æ„åœ–æè¿°

export interface Command<TType extends string = string, TPayload = unknown> {
  readonly type: TType
  readonly payload: TPayload
  readonly causation?: Causation
  readonly correlationId?: CorrelationId
}

ğŸ”’ ä¸è®Šæ¢æ¬¾ï¼š

Command â‰  Event

Command å¯èƒ½å¤±æ•—

ä¸è¨˜éŒ„ occurredAt



---

3ï¸âƒ£ Causation.ts â€” çˆ¶å­å› æœ

export interface Causation {
  readonly eventId: string
  readonly type: string
}

ğŸ”’ ä¸è®Šæ¢æ¬¾ï¼š

åªèƒ½æŒ‡å‘ã€Œå·²ç™¼ç”Ÿäº‹ä»¶ã€

ä¸å…è¨± optional æ¬„ä½ï¼ˆè¦å˜›æœ‰ï¼Œè¦å˜›æ˜¯èµ·é»ï¼‰



---

4ï¸âƒ£ Correlation.ts â€” æ•…äº‹ç·š

export type CorrelationId = string

ğŸ”’ ä¸è®Šæ¢æ¬¾ï¼š

ä¸åŒ…å«èªæ„

ä¸è§£æã€ä¸è¨ˆç®—

åªæ˜¯ã€Œç·šç´¢ã€



---

5ï¸âƒ£ SagaContext.ts â€” Saga ç‹€æ…‹å®¹å™¨

export interface SagaContext {
  readonly sagaId: string
  readonly status: 'pending' | 'completed' | 'failed'
}

ğŸ”’ ä¸è®Šæ¢æ¬¾ï¼š

åªæ”¾ã€Œç‹€æ…‹äº‹å¯¦ã€

ä¸æ”¾ service / handler

ä¸æ”¾ transient flag



---

6ï¸âƒ£ Saga.ts â€” ç´”ç‹€æ…‹æ©Ÿ

export interface Saga<
  TContext extends SagaContext,
  TEvent extends Event
> {
  readonly sagaType: string

  initialContext(event: TEvent): TContext

  transition(
    context: TContext,
    event: TEvent
  ): SagaTransition<TContext> | null
}

ğŸ”’ ä¸è®Šæ¢æ¬¾ï¼š

ä¸åš I/O

ä¸ dispatch command

ä¸è®€ DB



---

7ï¸âƒ£ SagaTransition.ts â€” ç‹€æ…‹é·ç§»çµæœ

export interface SagaTransition<TContext> {
  readonly nextContext: TContext
  readonly commands?: readonly Command[]
}

ğŸ”’ ä¸è®Šæ¢æ¬¾ï¼š

ç‹€æ…‹èˆ‡æ„åœ–åˆ†é›¢

commands å¯ç‚ºç©º

ä¸å…è¨± side effect



---

8ï¸âƒ£ Compensation.ts â€” è£œå„Ÿå®£å‘Š

export interface Compensation<TContext extends SagaContext> {
  when(context: TContext): boolean
  execute(context: TContext): readonly Command[]
}

ğŸ”’ ä¸è®Šæ¢æ¬¾ï¼š

è£œå„Ÿæ˜¯ declarative

ä¸çŸ¥é“å¤±æ•—åŸå› 

åªçœ‹ context



---

9ï¸âƒ£ Clock.ts â€” æ™‚é–“æŠ½è±¡

export interface Clock {
  now(): Date
}

ğŸ”’ ä¸è®Šæ¢æ¬¾ï¼š

ä¸ç”¨ Date.now() ç›´å‘¼

Replay / Test å¿…é ˆå¯æ§



---

ğŸ”Ÿ Identity.ts â€” å”¯ä¸€æ€§æŠ½è±¡

export interface IdentityGenerator {
  newId(): string
}

ğŸ”’ ä¸è®Šæ¢æ¬¾ï¼š

ä¸ç”¨ uuid ç›´å‘¼

å¼•æ“ä¸ç¶å¯¦ä½œ



---

1ï¸âƒ£1ï¸âƒ£ Invariants.ts â€” ç³»çµ±ä¸è®Šé‡ï¼ˆå¯é¸ä½†è¶…å€¼ï¼‰

export interface Invariant {
  name: string
  check(): void
}

ç”¨é€”ï¼š

å•Ÿå‹•æ™‚é©—è­‰

é˜²æ­¢å¼•æ“è¢«éŒ¯ç”¨

ã€Œé€™æ¢ç ´äº†å°±ç‚¸ã€



---

ğŸš« kernel å±¤ã€Œä¸‰ä¸åŸå‰‡ã€ï¼ˆè«‹è²¼ç‰†ä¸Šï¼‰

âŒ ä¸ import domain
âŒ ä¸ import platform
âŒ ä¸å‡ºç¾ä»»ä½•æ¥­å‹™åè©

å¦‚æœå“ªå¤©ä½ çœ‹åˆ°ï¼š

import { Workspace } from ...

ğŸ‘‰ é€™å±¤å°±è©²è¢«æ“‹ CI äº† ğŸ˜¼


---

ğŸª„ æ”¶å°¾ä¸€å¥ï¼ˆçœŸå¿ƒï¼‰

> é€™ä¸æ˜¯ä¸€çµ„æª”æ¡ˆ
é€™æ˜¯ä¸€æ¢ã€Œä½ ä¸æœƒå†æ¨å€’ core-engine çš„çµç•Œã€
