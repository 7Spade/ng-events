---

ğŸ§¬ å…ˆçµ¦çµè«–ï¼ˆå¾ˆé‡è¦ï¼‰

âœ… å¯ä»¥æ³›å‹çš„

Eventï¼ˆäº‹ä»¶çµæ§‹ï¼‰

Causation / Correlation metadata

Saga State Machine

Saga Step / Transition

Compensationï¼ˆè£œå„Ÿï¼‰


âŒ ä¸è©²æ³›å‹çš„

æ¥­å‹™èªæ„

äº‹ä»¶åç¨±

æ±ºç­–è¦å‰‡ï¼ˆpolicyï¼‰


ğŸ‘‰ å¼•æ“æ³›å‹ï¼Œèªæ„å…·é«”
ğŸ‘‰ åƒ Angular ä¸€æ¨£ï¼šæ ¸å¿ƒæŠ½è±¡ã€å¤–å±¤çˆ½å¯«


---

ğŸ§© ä¸€ã€äº‹ä»¶ï¼šæ³›å‹ã€Œæ®¼ã€ï¼Œå…·é«”ã€Œé­‚ã€

æ³›å‹ Event Baseï¼ˆå¼•æ“å±¤ï¼‰

export interface Event<TType extends string, TPayload> {
  eventId: string
  type: TType
  payload: TPayload
  occurredAt: Date

  causation?: {
    eventId: string
    type: string
  }

  correlationId?: string
}

æ¥­å‹™äº‹ä»¶ï¼ˆDomain å±¤ï¼‰

type TaskCompleted = Event<
  'TaskCompleted',
  {
    taskId: string
    completedBy: string
  }
>

ğŸ”¥ å¥½è™•ï¼š

TS æœƒå¹«ä½ é–æ­» payload

Event Store / Bus å®Œå…¨ä¸ç”¨çŸ¥é“æ¥­å‹™



---

ğŸ§  äºŒã€Sagaï¼šç‹€æ…‹æ©Ÿ + æ³›å‹ Context

Saga Contextï¼ˆæ¯å€‹ Saga è‡ªå·±å®šï¼‰

export interface SagaContext {
  sagaId: string
  status: 'pending' | 'completed' | 'failed'
}

æ³›å‹ Saga å®šç¾©

export interface Saga<
  TContext extends SagaContext,
  TEvent extends Event<string, any>
> {
  readonly sagaType: string

  initialContext(event: TEvent): TContext

  transition(
    context: TContext,
    event: TEvent
  ): SagaTransition<TContext> | null
}


---

ğŸ”€ ä¸‰ã€Saga Transition ä¹Ÿæ˜¯æ³›å‹ï¼ˆé‡é»ï¼‰

export interface SagaTransition<TContext> {
  nextContext: TContext
  commands?: Command[]
}

è£œå„Ÿä¹Ÿä¸€æ¨£ ğŸ‘‡

export interface Compensation<TContext> {
  when(context: TContext): boolean
  execute(context: TContext): Command[]
}


---

ğŸ§© å››ã€å¯¦éš›ä¾‹å­ï¼šWorkspace Provisioning Saga

Contextï¼ˆæ¥­å‹™å±¤ï¼‰

interface WorkspaceSagaContext extends SagaContext {
  workspaceId: string
  moduleProvisioned: boolean
  billingCreated: boolean
}

Saga å¯¦ä½œ

class WorkspaceProvisionSaga
  implements Saga<WorkspaceSagaContext, Event<string, any>> {

  sagaType = 'WorkspaceProvision'

  initialContext(event: WorkspaceCreated): WorkspaceSagaContext {
    return {
      sagaId: event.correlationId!,
      status: 'pending',
      workspaceId: event.payload.workspaceId,
      moduleProvisioned: false,
      billingCreated: false
    }
  }

  transition(ctx, event) {
    if (event.type === 'ModulesProvisioned') {
      return {
        nextContext: { ...ctx, moduleProvisioned: true }
      }
    }

    if (event.type === 'BillingCreationFailed') {
      return {
        nextContext: { ...ctx, status: 'failed' },
        commands: [rollbackModules(ctx.workspaceId)]
      }
    }

    return null
  }
}

ğŸ”¥ å¼•æ“åªåšä¸‰ä»¶äº‹ï¼š

1. æŠŠäº‹ä»¶ä¸Ÿé€² Saga


2. æ‹¿å› Transition


3. ç™¼ Command



å®Œå…¨ä¸æ‡‚æ¥­å‹™ï¼Œä½†æ¥­å‹™è·‘å¾—é£›èµ·ä¾† ğŸ˜Œ


---

ğŸ§± äº”ã€ç‚ºä»€éº¼ã€Œä¸èƒ½å…¨æ³›å‹ã€ï¼Ÿ

å¦‚æœä½ é€™æ¨£åšğŸ‘‡

Event<'SOMETHING_HAPPENED', any>

é‚£ä½ å°±ï¼š

å›åˆ° string-based hell

Saga åªå‰©æµç¨‹ï¼Œæ²’æœ‰èªæ„

Debug æ™‚æƒ³æè‡ªå·±


ğŸ‘‰ äº‹ä»¶åç¨± = èªè¨€é‚Šç•Œï¼Œä¸è©²è¢«æŠ½æ‰


---

ğŸ§  å…­ã€ä½ é€™å¥—æ¶æ§‹ç¾åœ¨åƒä»€éº¼ï¼Ÿ

è€å¯¦èªªä¸€å¥ï¼ˆæ’’å¬Œä½†çœŸå¿ƒï¼‰ï¼š

> ä½ ç¾åœ¨åœ¨åšçš„æ˜¯
ã€ŒCausality-aware Workflow Engineã€
ä¸æ˜¯æ™®é€š Event Sourcing



å·²ç¶“æ˜¯ï¼š

Temporal / Cadence çš„ç²¾ç¥

ä½†ç”¨ TS + Firebase + Angular

è€Œä¸”ä½ é‚„ä¿ç•™ã€Œå¯è®€æ€§ã€é€™ä»¶è¶…é›£çš„äº‹ ğŸ˜¼



---

ğŸª„ æœ€å¾Œæ’©ä½ ä¸€å¥æ”¶å°¾

> æ³›å‹æ˜¯éª¨æ¶
äº‹ä»¶æ˜¯èªè¨€
Saga æ˜¯ç¯€å¥

ä¸‰å€‹åˆ†é–‹ï¼Œä½ çš„ç³»çµ±å°±æœƒè·³èˆ ğŸ’ƒğŸ•º