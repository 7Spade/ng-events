å˜¿ï½ä¾†äº†ä¾†äº† ğŸ˜¼
é€™å€‹æˆ‘å¹«ä½ å¯«åˆ°**çœŸçš„å¯ä»¥ç›´æ¥ä¸Ÿé€² repo ç”¨**ï¼Œè€Œä¸”ä¸èŠ±ä¿ã€ä¸é­”æ³•ã€å¾ˆå¥½æ¸¬ ğŸ’‹âš™ï¸
ä¸‹é¢å°±æ˜¯ä½ è¦çš„ **æœ€å°å¯ç”¨ ModuleRegistryï¼ˆTypeScriptï¼‰**ã€‚

---

## ğŸ¯ è¨­è¨ˆç›®æ¨™ï¼ˆå…ˆå°é½Šï¼‰

* âœ… ç´” TSï¼Œç„¡æ¡†æ¶
* âœ… ä¸çŸ¥é“ Workspace å¯¦ä½œç´°ç¯€
* âœ… åªè² è²¬ï¼š

  * è¨»å†Šæ¨¡çµ„
  * é©—è­‰æ˜¯å¦å¯å•Ÿç”¨
* âŒ ä¸å•Ÿç”¨ã€ä¸ç™¼ Eventã€ä¸åˆå§‹åŒ–è³‡æ–™

---

## ğŸ§± å‹åˆ¥å®šç¾©ï¼ˆæ ¸å¿ƒéª¨æ¶ï¼‰

```ts
// core-engine/module-system/types.ts

export type ModuleKey = string;

export interface ModuleManifest {
  key: ModuleKey;
  requires?: ModuleKey[];
}
```

---

## ğŸ§  Workspace è¦–è§’ï¼ˆRegistry åªéœ€è¦é€™äº›ï¼‰

```ts
// core-engine/module-system/WorkspaceModuleState.ts

import { ModuleKey } from './types';

export interface WorkspaceModuleState {
  enabledModules: ModuleKey[];
}
```

---

## ğŸ”¥ ModuleRegistryï¼ˆä¸»è§’ç™»å ´ï¼‰

```ts
// core-engine/module-system/ModuleRegistry.ts

import { ModuleKey, ModuleManifest } from './types';
import { WorkspaceModuleState } from './WorkspaceModuleState';

export class ModuleRegistry {
  private manifests = new Map<ModuleKey, ModuleManifest>();

  register(manifest: ModuleManifest): void {
    if (this.manifests.has(manifest.key)) {
      throw new Error(`Module already registered: ${manifest.key}`);
    }

    this.manifests.set(manifest.key, manifest);
  }

  canEnable(
    moduleKey: ModuleKey,
    workspace: WorkspaceModuleState
  ): boolean {
    const manifest = this.manifests.get(moduleKey);
    if (!manifest) return false;

    const enabled = new Set(workspace.enabledModules);

    return (manifest.requires ?? []).every(dep =>
      enabled.has(dep)
    );
  }

  getRegisteredModules(): ModuleKey[] {
    return Array.from(this.manifests.keys());
  }
}
```

---

## ğŸ§ª ä½¿ç”¨ç¯„ä¾‹ï¼ˆä½ ä¸€çœ‹å°±æœƒç”¨ï¼‰

### 1ï¸âƒ£ è¨»å†Šæ¨¡çµ„ï¼ˆç³»çµ±å•Ÿå‹•æ™‚ï¼‰

```ts
const registry = new ModuleRegistry();

registry.register({
  key: 'task',
});

registry.register({
  key: 'payment',
  requires: ['task'],
});
```

---

### 2ï¸âƒ£ Workspace é©—è­‰ï¼ˆAggregate è£¡ï¼‰

```ts
function enableModule(
  workspace: WorkspaceModuleState,
  moduleKey: ModuleKey,
  registry: ModuleRegistry
) {
  if (!registry.canEnable(moduleKey, workspace)) {
    throw new Error('Module requirements not satisfied ğŸ˜¾');
  }

  // ç™¼ WorkspaceModuleEnabled Event
}
```

---

## ğŸ§  ç‚ºä»€éº¼é€™æ¨£å°±å¤ äº†ï¼Ÿ

å› ç‚ºï¼š

* ä¾è³´å®£å‘Šåœ¨æ¨¡çµ„
* ç‹€æ…‹åœ¨ Workspace
* åˆ¤æ–·é‚è¼¯é›†ä¸­
* Event é‚„åœ¨ä½  Aggregate è£¡

ğŸ‘‰ Registry **ä¸ç¢°å› æœã€ä¸ç¢°äº‹ä»¶**

é€™å°±æ˜¯å®ƒè©²æœ‰çš„å°ºå¯¸ ğŸ˜Œ

---

## âŒ Registry çµ•å°ä¸è¦åšçš„äº‹ï¼ˆè«‹åˆ»åœ¨è…¦è£¡ï¼‰

* âŒ å­˜ Workspace
* âŒ ç™¼ Event
* âŒ åˆå§‹åŒ– Read Model
* âŒ çŸ¥é“æ¨¡çµ„å…§éƒ¨ API

---

## ğŸ«¦ é€²éšï¼ˆç­‰ä½ è¦å†ä¾†ï¼‰

ç­‰ä½ ä¹‹å¾Œæƒ³å‡ç´šï¼Œæˆ‘å¯ä»¥å¹«ä½ åŠ ï¼š

* æ¨¡çµ„åœç”¨ï¼ˆdisableï¼‰
* æ¨¡çµ„ç‰ˆæœ¬ï¼ˆtask@2ï¼‰
* æ¨¡çµ„èƒ½åŠ›æ——æ¨™ï¼ˆcapabilitiesï¼‰
* æ¨¡çµ„è¡çªï¼ˆconflictsï¼‰

**ä½†ç¾åœ¨é€™ç‰ˆï¼Œå‰›å‰›å¥½ï¼Œä¸æœƒå¤ªé¨·ä¹Ÿä¸æœƒå¤ªè‚¥** ğŸ˜¼

---

## ğŸ’Œ æœ€å¾Œä¸€å¥çœŸå¿ƒè©±

ä½ ç¾åœ¨é€™å€‹ ModuleRegistry
å·²ç¶“ä¸æ˜¯ã€ŒTask çš„å·¥å…·ã€
æ˜¯ä½ æ•´å€‹å¹³å°çš„ **æ’æ§½æ¨™æº–**ã€‚

ä¹‹å¾Œä»»ä½•äººè¦åŠ æ¨¡çµ„ï¼Œ
éƒ½å¾—å…ˆå°å®ƒé èº¬ ğŸ™‡â€â™‚ï¸

å¦‚æœä½ è¦ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¹«ä½ ï¼š

* âœ¨ æŠŠå®ƒå¡é€² Workspace Aggregateï¼ˆå« Eventï¼‰
* âœ¨ å¹«ä½ å¯«æœ€å° EnableModule æµç¨‹
* âœ¨ å¹«ä½ æŠŠ Task / Payment çš„ manifest å¯«æˆä¸€çµ„ç¯„ä¾‹

ä¾†å˜›ï½ç¹¼çºŒï¼Œæˆ‘é‚„åœ¨ ğŸ˜¼ğŸ’‹
