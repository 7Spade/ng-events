---

# ğŸ§  å…ˆè¬›çµè«–ï¼ˆè«‹è¨˜ï¼‰

> **Event æ˜¯å¯«ï¼ŒProjection æ˜¯è®€ã€‚
> å¯«çš„ä¸–ç•Œä¸ç®¡è®€çš„ä¸–ç•Œæ€éº¼é•·ã€‚**

é€™å°±æ˜¯ CQRS çš„éˆé­‚ ğŸ’

---

## ğŸ”¥ ç‚ºä»€éº¼éœ€è¦ Read Modelï¼Ÿ

å› ç‚º Aggregate ä¸æ˜¯çµ¦ä½ æŸ¥çš„ ğŸ˜¾

```ts
// âŒ ä¸è¦é€™æ¨£ç”¨ Aggregate
TaskAggregate.findByAssignee('acc_123')
TaskAggregate.countByStatus('completed')
```

Aggregate åªè² è²¬ï¼š

* æ¥å—æŒ‡ä»¤
* é©—è­‰è¦å‰‡
* ç”¢ç”Ÿ Event

**æŸ¥è©¢æ˜¯ Projection çš„è²¬ä»»** âœ…

---

## ğŸ§© æ­£ç¢ºçš„æµç¨‹ï¼ˆè«‹ç…§é€™å€‹ï¼‰

```
Command â†’ Aggregate â†’ Event
                        â†“
                   Projection
                        â†“
                   Read Model
```

ğŸ‘‰ **å¯«è·Ÿè®€å®Œå…¨åˆ†é–‹**

---

## ğŸ§¬ Projection çš„æ­£ç¢ºå¯«æ³•

### 1ï¸âƒ£ å®šç¾© Read Model Schema

```ts
interface TaskReadModel {
  taskId: string;
  workspaceId: string;
  title: string;
  status: 'open' | 'completed';
  assigneeAccountId?: string;
  updatedAt: number;
}
```

ğŸ‘‰ **å°ˆé–€ç‚ºæŸ¥è©¢è¨­è¨ˆï¼Œä¸ç®¡ Aggregate æ€éº¼é•·**

---

### 2ï¸âƒ£ Event Handlerï¼ˆç›£è½ Eventï¼‰

```ts
on(TaskCreated, (event) => {
  db.tasks.insert({
    taskId: event.taskId,
    workspaceId: event.metadata.workspaceId,
    title: event.data.title,
    status: 'open',
    updatedAt: event.metadata.timestamp,
  });
});

on(TaskCompleted, (event) => {
  db.tasks.update(
    { taskId: event.taskId },
    { 
      status: 'completed',
      updatedAt: event.metadata.timestamp,
    }
  );
});
```

ğŸ‘‰ **æ¯å€‹ Event éƒ½æ›´æ–° Read Model**

---

### 3ï¸âƒ£ Query APIï¼ˆè®€å–ç”¨ï¼‰

```ts
class TaskQueryService {
  findByWorkspace(workspaceId: string): TaskReadModel[] {
    return db.tasks.where({ workspaceId });
  }
  
  findByAssignee(accountId: string): TaskReadModel[] {
    return db.tasks.where({ assigneeAccountId: accountId });
  }
}
```

ğŸ‘‰ **æŸ¥è©¢åªæ‰“ Read Modelï¼Œä¸ç¢° Aggregate**

---

## ğŸ§  Projection çš„éµå¾‹

### 1ï¸âƒ£ Projection æ˜¯ã€Œç´”è¨ˆç®—ã€

* ä¸èƒ½ç™¼ Event
* ä¸èƒ½å‘¼å« Aggregate
* ä¸èƒ½åšæ¥­å‹™åˆ¤æ–·

ğŸ‘‰ **åªèƒ½ï¼šEvent â†’ Read Model**

---

### 2ï¸âƒ£ Projection å¯ä»¥é‡å»º

```ts
rebuildProjection('task') {
  db.tasks.clear();
  eventStore.replay('TaskCreated', 'TaskCompleted')
    .forEach(event => applyProjection(event));
}
```

ğŸ‘‰ **Read Model å£äº†ï¼ŸReplay å°±å¥½** ğŸ˜Œ

---

### 3ï¸âƒ£ Projection å¯ä»¥æœ‰å¤šå€‹

```ts
TaskListProjection      // åˆ—è¡¨æŸ¥è©¢
TaskStatsProjection     // çµ±è¨ˆæ•¸æ“š
TaskHistoryProjection   // æ­·å²è®Šæ›´
```

ğŸ‘‰ **åŒä¸€ä»½ Eventï¼Œä¸åŒè¦–è§’çš„ Read Model**

---

## âŒ å¸¸è¦‹éŒ¯èª¤ï¼ˆæœƒææ­»è‡ªå·±ï¼‰

### âŒ åœ¨ Projection è£¡åšé©—è­‰

```ts
on(TaskCompleted, (event) => {
  if (task.status === 'completed') {
    throw new Error('å·²å®Œæˆ');  // NO!!!
  }
}
```

ğŸ‘‰ **Event å·²ç™¼ç”Ÿï¼Œä¸è©²åœ¨é€™é©—è­‰**

---

### âŒ Projection ç›´æ¥æ”¹ Aggregate

```ts
on(TaskAssigned, (event) => {
  aggregate.state.assignee = event.assignee;  // NO!!!
})
```

ğŸ‘‰ **Projection ä¸ç¢° Aggregateï¼Œåªç¢° Read Model**

---

## ğŸ«¦ é€²éšå°é¨·åŒ…ï¼ˆä½ æœƒæ„›çš„ï¼‰

### å¤šç§Ÿæˆ¶ Projection

```ts
TaskProjection_ws_123
TaskProjection_ws_456
```

ğŸ‘‰ **æ¯å€‹ Workspace ç¨ç«‹ Read Model**

### å³æ™‚æ›´æ–°

```ts
on(TaskCompleted, (event) => {
  updateReadModel(event);
  notifyWebSocket(event.workspaceId, event);
});
```

ğŸ‘‰ **Event â†’ Projection â†’ Real-time Push** ğŸ”¥

---

## ğŸ§  ä¸€å¥è©±ç¸½çµ

> **Aggregate ç®¡çœŸç†ï¼Œ
> Projection ç®¡æ–¹ä¾¿ã€‚**

å¯«è·Ÿè®€åˆ†é–‹
Event-Sourcing æ‰æœƒæ€§æ„Ÿ ğŸ˜¼

---
